---
# tasks file for docker_toolbox(On Debian family)
- name: Download install script for Docker Engine with get_url module
  get_url: url="https://get.docker.com" dest="{{ docker_installscript_tmppath }}"
  when: "{{ ansible_python_version | version_compare('2.7.9', '>=') }}"
# get_url module on Python(< 2.7.9) cause SSL error
- block:
    - name: Check whether install script for Docker Engine exists
      stat: path="{{ docker_installscript_tmppath }}"
      register: st_result_docker
      changed_when: no
    - name: Download install script for Docker Engine with curl
      command: "curl https://get.docker.com -o {{ docker_installscript_tmppath }}"
      when: not st_result_docker.stat.exists
  when: "{{ ansible_python_version | version_compare('2.7.9', '<') }}"
- name: Check whether Docker Engine is installed
  command: "which docker"
  register: which_docker
  changed_when: no
  ignore_errors: yes
- name: Install Docker Engine
  shell: "sh {{ docker_installscript_tmppath }}"
  become: yes
  when: which_docker.rc != 0
- block:
  - name: Install Docker Machine
    get_url: url="{{ docker_machine_download_url }}" checksum="sha256:{{ docker_machine_sha256 }}" dest="{{ docker_machine_bin_path }}" mode="0755"
    become: yes
    when: "{{ ansible_python_version | version_compare('2.7.9', '>=') }}"
  # get_url module on Python(< 2.7.9) cause SSL error
  - block:
      - name: Check whether Docker Machine exists
        stat: path="{{ docker_machine_bin_path }}"
        register: st_result_docker_machine
        changed_when: no
      - name: Download Docker Machine binary with curl
        command: "curl {{ docker_machine_download_url }} -o {{ docker_machine_bin_path }}"
        become: yes
        when: not st_result_docker_machine.stat.exists
      - name: Make Docker Machine binary executable
        file: path="{{ docker_machine_bin_path }}" mode="0755"
        become: yes
    when: "{{ ansible_python_version | version_compare('2.7.9', '<') }}"
  when: "docker_machine_is_installed"
- block:
  - name: Install Docker Compose
    get_url: url="{{ docker_compose_download_url }}" checksum="sha256:{{ docker_compose_sha256 }}" dest="{{ docker_compose_bin_path }}" mode="0755"
    become: yes
    when: "{{ ansible_python_version | version_compare('2.7.9', '>=') }}"
  # get_url module on Python(< 2.7.9) cause SSL error
  - block:
      - name: Check whether Docker Compose exists
        stat: path="{{ docker_compose_bin_path }}"
        register: st_result_docker_compose
        changed_when: no
      - name: Download Docker Compose binary with curl
        command: "curl {{ docker_compose_download_url }} -o {{ docker_compose_bin_path }}"
        become: yes
        when: not st_result_docker_compose.stat.exists
      - name: Make Docker Compose binary executable
        file: path="{{ docker_compose_bin_path }}" mode="0755"
        become: yes
    when: "{{ ansible_python_version | version_compare('2.7.9', '<') }}"
  when: "docker_compose_is_installed"
